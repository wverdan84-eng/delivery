<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sistema de Pedidos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
    }

    header {
      background: #111;
      color: #fff;
      padding: 14px;
      text-align: center;
      font-size: 18px;
    }

    .container {
      padding: 16px;
      max-width: 900px;
      margin: auto;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    input, select, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      font-size: 15px;
    }

    button {
      background: #2e7d32;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button.secondary {
      background: #1565c0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .hidden {
      display: none;
    }

    .status {
      font-weight: bold;
    }
  </style>
</head>
<body>

<header>Sistema de Pedidos</header>

<div class="container">

  <!-- LOGIN -->
  <div class="card" id="loginBox">
    <h3>Login por e-mail</h3>
    <input type="email" id="emailLogin" placeholder="Seu e-mail" />
    <button onclick="login()">Enviar link de acesso</button>
    <p id="loginMsg"></p>
  </div>

  <!-- DASHBOARD -->
  <div class="card hidden" id="dashboardBox">
    <h3>Dashboard</h3>
    <p>Total de pedidos: <b id="dashPedidos">0</b></p>
    <p>Faturamento: <b>R$ <span id="dashTotal">0</span></b></p>
  </div>

  <!-- NOVO PEDIDO -->
  <div class="card hidden" id="pedidoBox">
    <h3>Novo Pedido</h3>

    <input id="clienteNome" placeholder="Nome do cliente" />
    <input id="clienteWhats" placeholder="WhatsApp do cliente" />

    <select id="produtoSelect"></select>
    <input id="qtdProduto" type="number" placeholder="Quantidade" value="1" />

    <button onclick="addItem()">Adicionar item</button>

    <ul id="itensLista"></ul>

    <p><b>Total: R$ <span id="totalPedido">0</span></b></p>

    <button onclick="enviarPedido()">Finalizar Pedido</button>
  </div>

  <!-- PEDIDOS -->
  <div class="card hidden" id="pedidosBox">
    <h3>Pedidos</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Cliente</th>
          <th>Total</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="listaPedidos"></tbody>
    </table>
  </div>

</div>

<script>
/* ================= CONFIG ================= */
const WEBAPP_URL = "COLE_AQUI_A_URL_DO_SEU_WEBAPP";

/* ================= ESTADO ================= */
let email = "";
let lojaId = "";
let produtos = [];
let itens = [];

/* ================= LOGIN ================= */
function login() {
  const em = document.getElementById("emailLogin").value;
  fetch(`${WEBAPP_URL}?action=login&email=${encodeURIComponent(em)}`)
    .then(r => r.json())
    .then(() => {
      document.getElementById("loginMsg").innerText =
        "Link enviado para seu e-mail.";
    });
}

function validarToken() {
  const p = new URLSearchParams(window.location.search);
  const token = p.get("token");
  if (!token) return;

  fetch(`${WEBAPP_URL}?action=validar&token=${token}`)
    .then(r => r.json())
    .then(d => {
      email = d.email;
      lojaId = d.loja_id;
      iniciarSistema();
    });
}

/* ================= SISTEMA ================= */
function iniciarSistema() {
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("dashboardBox").classList.remove("hidden");
  document.getElementById("pedidoBox").classList.remove("hidden");
  document.getElementById("pedidosBox").classList.remove("hidden");

  carregarDashboard();
  carregarProdutos();
  carregarPedidos();
}

function carregarDashboard() {
  fetch(`${WEBAPP_URL}?action=dashboard&email=${email}&loja_id=${lojaId}`)
    .then(r => r.json())
    .then(d => {
      document.getElementById("dashPedidos").innerText = d.pedidos;
      document.getElementById("dashTotal").innerText = d.faturamento;
    });
}

function carregarProdutos() {
  fetch(`${WEBAPP_URL}?action=produtos&loja_id=${lojaId}`)
    .then(r => r.json())
    .then(d => {
      produtos = d;
      const sel = document.getElementById("produtoSelect");
      sel.innerHTML = "";
      d.forEach(p => {
        const o = document.createElement("option");
        o.value = p.id;
        o.text = `${p.nome} - R$ ${p.preco}`;
        o.dataset.preco = p.preco;
        sel.appendChild(o);
      });
    });
}

/* ================= PEDIDO ================= */
function addItem() {
  const sel = document.getElementById("produtoSelect");
  const qtd = Number(document.getElementById("qtdProduto").value);
  const preco = Number(sel.selectedOptions[0].dataset.preco);

  itens.push({
    nome: sel.selectedOptions[0].text,
    qtd: qtd,
    total: qtd * preco
  });

  renderItens();
}

function renderItens() {
  const ul = document.getElementById("itensLista");
  ul.innerHTML = "";
  let total = 0;

  itens.forEach(i => {
    total += i.total;
    const li = document.createElement("li");
    li.innerText = `${i.nome} (${i.qtd})`;
    ul.appendChild(li);
  });

  document.getElementById("totalPedido").innerText = total;
}

function enviarPedido() {
  fetch(WEBAPP_URL, {
    method: "POST",
    body: JSON.stringify({
      action: "novoPedido",
      loja_id: lojaId,
      cliente_nome: document.getElementById("clienteNome").value,
      cliente_whatsapp: document.getElementById("clienteWhats").value,
      itens: JSON.stringify(itens),
      total: document.getElementById("totalPedido").innerText
    })
  }).then(() => {
    itens = [];
    renderItens();
    carregarDashboard();
    carregarPedidos();
    alert("Pedido enviado!");
  });
}

/* ================= LISTAGEM ================= */
function carregarPedidos() {
  fetch(`${WEBAPP_URL}?action=pedidos&email=${email}&loja_id=${lojaId}`)
    .then(r => r.json())
    .then(d => {
      const tb = document.getElementById("listaPedidos");
      tb.innerHTML = "";
      d.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.cliente}</td>
          <td>R$ ${p.total}</td>
          <td class="status">${p.status}</td>
        `;
        tb.appendChild(tr);
      });
    });
}

/* ================= INIT ================= */
validarToken();
</script>

</body>
</html>
