<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel SaaS Profissional</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.4.13/dist/cdn/beer.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.4.13/dist/cdn/beer.min.js"></script>
</head>
<body class="light">

    <div id="login-box" class="container small padding">
        <article class="card shadow">
            <h3>Login</h3>
            <div class="field label border"><input type="email" id="email"><label>Email</label></div>
            <div class="field label border"><input type="password" id="senha"><label>Senha</label></div>
            <button class="fill primary full-width" onclick="login()">Entrar</button>
        </article>
    </div>

    <main id="app" style="display:none" class="responsive padding">
        <header class="primary shadow no-margin">
            <nav>
                <h5 class="max bold" id="nome-da-loja-topo">Carregando...</h5>
                <button class="circle transparent" onclick="location.reload()"><i>logout</i></button>
            </nav>
        </header>

        <div class="card secondary-container padding margin-top center-align">
            <p>Seu link de catálogo para clientes:</p>
            <a id="link-final" href="#" target="_blank" class="bold blue-text">Gerando link...</a>
        </div>

        <div class="card white padding margin-top">
            <h5>➕ Cadastrar Produto</h5>
            <div class="field label border"><input type="text" id="p-nome"><label>Nome</label></div>
            <div class="grid">
                <div class="s6 field label border"><input type="text" id="p-preco"><label>Preço</label></div>
                <div class="s6 field label border"><input type="number" id="p-estoque" value="10"><label>Estoque</label></div>
            </div>
            <div class="field label border">
                <select id="p-cat">
                    <option value="Geral">Geral</option>
                    <option value="Destaques">Destaques</option>
                    <option value="Promoção">Promoção</option>
                </select>
                <label>Categoria</label>
            </div>
            <div class="field label border">
                <input type="file" accept="image/*" onchange="compactarImg(this)">
                <label>Foto</label>
                <input type="hidden" id="p-img">
            </div>
            <button id="btn-salvar" class="fill green full-width" onclick="salvar()">Salvar Produto</button>
        </div>

        <h5 class="margin-top">Meus Produtos</h5>
        <div id="lista" class="grid"></div>
    </main>

    <script>
        const API = "URL_DO_SEU_SCRIPT_AQUI"; // <--- COLOQUE A URL AQUI

        function compactarImg(el) {
            const reader = new FileReader();
            reader.readAsDataURL(el.files[0]);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 500; canvas.height = 500;
                    ctx.drawImage(img, 0, 0, 500, 500);
                    document.getElementById('p-img').value = canvas.toDataURL('image/jpeg', 0.6);
                }
            }
        }

        async function login() {
            const e = document.getElementById('email').value;
            const s = document.getElementById('senha').value;
            const res = await fetch(`${API}?action=login&email=${e}&senha=${s}`);
            const d = await res.json();
            if(d.auth) {
                localStorage.setItem('user', JSON.stringify(d));
                renderApp();
            } else alert("Erro no login");
        }

        function renderApp() {
            const d = JSON.parse(localStorage.getItem('user'));
            document.getElementById('login-box').style.display='none';
            document.getElementById('app').style.display='block';
            document.getElementById('nome-da-loja-topo').innerText = d.loja;
            
            // CORREÇÃO DO LINK:
            const linkBase = window.location.href.split('index.html')[0];
            const linkFinal = `${linkBase}view.html?loja=${d.email}`;
            document.getElementById('link-final').innerText = linkFinal;
            document.getElementById('link-final').href = linkFinal;
            
            carregar();
        }

        async function salvar() {
            const u = JSON.parse(localStorage.getItem('user'));
            const btn = document.getElementById('btn-salvar');
            btn.disabled = true;

            const dados = {
                action: "cadastrarProduto",
                dono: u.email,
                nome: document.getElementById('p-nome').value,
                preco: document.getElementById('p-preco').value,
                estoque: document.getElementById('p-estoque').value,
                cat: document.getElementById('p-cat').value, // SALVANDO CATEGORIA
                img: document.getElementById('p-img').value
            };

            await fetch(API, { method: 'POST', body: JSON.stringify(dados) });
            alert("Salvo!");
            btn.disabled = false;
            carregar();
        }

        async function carregar() {
            const u = JSON.parse(localStorage.getItem('user'));
            const res = await fetch(`${API}?action=getProdutos&dono=${u.email}`);
            const d = await res.json();
            const list = document.getElementById('lista');
            list.innerHTML = d.produtos.map(p => `
                <div class="s12 m6 l4">
                    <div class="card white no-padding shadow">
                        <img src="${p.img}" style="height:150px; width:100%; object-fit:cover">
                        <div class="padding">
                            <p class="bold">${p.nome} | <span class="blue-text">${p.cat}</span></p>
                            <p class="green-text bold">R$ ${p.preco}</p>
                            <button class="border error small full-width" onclick="deletar('${p.nome}')">Excluir</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function deletar(n) {
            if(!confirm("Deletar?")) return;
            const u = JSON.parse(localStorage.getItem('user'));
            await fetch(API, { method: 'POST', body: JSON.stringify({action:"deletarProduto", dono:u.email, nome:n}) });
            carregar();
        }

        if(localStorage.getItem('user')) renderApp();
    </script>
</body>
</html>
