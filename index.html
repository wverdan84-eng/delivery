<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Control Panel</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.4.13/dist/cdn/beer.min.css">
</head>
<body>
    <div id="login-screen" class="padding center-align">
        <h4>üîê Acesso Lojista</h4>
        <div class="field label border"><input type="email" id="email"><label>Email</label></div>
        <div class="field label border"><input type="password" id="senha"><label>Senha</label></div>
        <button class="fill primary full-width" onclick="handleLogin()">Entrar</button>
    </div>

    <main id="admin-panel" style="display:none">
        <header class="primary shadow"><nav class="padding"><h6 class="max">Meu Painel</h6><button onclick="logout()">Sair</button></nav></header>
        
        <div class="padding">
            <div class="card border padding margin">
                <h6>üîó Seu Link para Clientes:</h6>
                <p id="share-link" class="blue-text" style="word-break: break-all;"></p>
                <button class="border small" onclick="copiarLink()">Copiar Link</button>
            </div>

            <h5>‚ûï Novo Produto</h5>
            <div class="field label border"><input type="text" id="p-nome"><label>Nome</label></div>
            <div class="field label border"><input type="number" id="p-preco"><label>Pre√ßo</label></div>
            <div class="field label border"><input type="text" id="p-img"><label>Link da Foto</label></div>
            <button class="fill green full-width" onclick="salvarProduto()">Cadastrar na Planilha</button>
            
            <hr>
            <h5>üì¶ Meus Produtos</h5>
            <div id="meus-produtos"></div>
        </div>
    </main>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwIxLFaCaB3oH2w3O2OO-FzQgje_VNk86r42DuMzxCaKZeAryfN-5OI9ZIs-WmVCBVr/exec";

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const senha = document.getElementById('senha').value;
            const res = await fetch(`${API_URL}?action=login&email=${email}&senha=${senha}`, {redirect: "follow"});
            const user = await res.json();
            if(user.auth) {
                localStorage.setItem('vendedor', user.email);
                abrirPainel();
            } else { alert("Erro!"); }
        }

        function abrirPainel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            // Macete: Gera o link autom√°tico da Vercel para o cliente dele
            const link = `${window.location.origin}/view.html?loja=${localStorage.getItem('vendedor')}`;
            document.getElementById('share-link').innerText = link;
            carregarMeusProdutos();
        }
async function carregarMeusProdutos() {
    const dono = localStorage.getItem('vendedor');
    const container = document.getElementById('meus-produtos');
    
    // Mostra um carregando simples
    container.innerHTML = "<p>Carregando seus produtos...</p>";

    try {
        const res = await fetch(`${API_URL}?action=getProdutos&dono=${dono}`, { redirect: "follow" });
        const produtos = await res.json();

        if (produtos.length === 0) {
            container.innerHTML = "<p>Voc√™ ainda n√£o tem produtos cadastrados.</p>";
            return;
        }

        container.innerHTML = produtos.map(p => `
            <div class="card border margin padding">
                <div class="nav">
                    <img src="${p.img}" width="50" height="50" style="object-fit:cover; border-radius:8px">
                    <div class="max">
                        <h6>${p.nome}</h6>
                        <p class="green-text">R$ ${parseFloat(p.preco).toFixed(2)}</p>
                    </div>
                </div>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = "<p>Erro ao carregar produtos.</p>";
    }
}

        async function salvarProduto() {
            const btn = event.target; btn.disabled = true;
            const dados = {
                action: "cadastrarProduto",
                dono: localStorage.getItem('vendedor'),
                nome: document.getElementById('p-nome').value,
                preco: document.getElementById('p-preco').value,
                img: document.getElementById('p-img').value,
                cat: "Geral"
            };

            await fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) });
            alert("Sucesso!");
            location.reload();
        }

        function copiarLink() {
            navigator.clipboard.writeText(document.getElementById('share-link').innerText);
            alert("Link copiado!");
        }

        window.onload = () => { if(localStorage.getItem('vendedor')) abrirPainel(); };
    </script>
</body>
</html>
