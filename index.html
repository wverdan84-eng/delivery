<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Lojista</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/beercss@3.4.13/dist/cdn/beer.min.css">
    <script type="module" src="https://cdn.jsdelivr.net/npm/beercss@3.4.13/dist/cdn/beer.min.js"></script>
    <style>
        body { background: #f0f4f8; padding-bottom: 60px; }
        .card { border-radius: 16px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .badge-estoque { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-screen" class="padding center-align container" style="max-width:400px; margin-top:10vh">
        <img src="https://cdn-icons-png.flaticon.com/512/2910/2910756.png" width="80" class="margin-bottom">
        <h4>Painel SaaS</h4>
        <div class="field label border round"><input type="email" id="email"><label>E-mail</label></div>
        <div class="field label border round"><input type="password" id="senha"><label>Senha</label></div>
        <button class="fill primary full-width round large" onclick="handleLogin()">Acessar Painel</button>
    </div>

    <main id="admin-panel" style="display:none">
        <header class="primary shadow">
            <nav class="padding">
                <button class="circle transparent" onclick="logout()"><i>logout</i></button>
                <h6 class="max center-align bold" id="display-loja">Carregando...</h6>
            </nav>
        </header>

        <div class="padding responsive">
            
            <div class="card primary-container padding margin center-align">
                <p class="small no-margin">Seu Link de Vendas:</p>
                <h6 id="share-link" class="bold blue-text" style="font-size:1rem; word-break: break-all; margin: 10px 0;">Gerando...</h6>
                <button class="border small round white-text" onclick="copiarLink()">Copiar Link</button>
            </div>

            <details class="card white padding margin shadow">
                <summary class="bold primary-text">‚öôÔ∏è Editar Dados da Loja</summary>
                <div class="padding">
                    <div class="field label border round small"><input type="text" id="edit-nome-loja"><label>Nome do Neg√≥cio</label></div>
                    <div class="field label border round small">
                        <select id="edit-nicho">
                            <option value="Geral">Geral</option>
                            <option value="Moda">Moda e Roupas</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                        </select>
                        <label>Nicho</label>
                    </div>
                    <button class="fill primary round small full-width" onclick="atualizarPerfil()">Salvar Altera√ß√µes</button>
                </div>
            </details>

            <article class="card white padding margin shadow">
                <h5>‚ûï Adicionar Produto</h5>
                <div class="field label border round"><input type="text" id="p-nome"><label>Nome do Produto</label></div>
                <div class="grid">
                    <div class="s6 field label border round"><input type="text" id="p-preco" placeholder="0,00"><label>Pre√ßo</label></div>
                    <div class="s6 field label border round"><input type="number" id="p-estoque" value="1"><label>Qtd Estoque</label></div>
                </div>
                <div class="field label border round">
                    <input type="file" id="p-file" accept="image/*" capture="environment" onchange="converterFoto()">
                    <label>üì∏ Foto do Produto</label>
                    <input type="hidden" id="p-img">
                </div>
                <button id="btn-salvar" class="fill green full-width round large" onclick="salvarProduto()">Publicar Agora</button>
            </article>

            <h5 class="padding">üì¶ Meu Estoque</h5>
            <div id="meus-produtos" class="grid padding"></div>
        </div>
    </main>

    <script>
        // --- CONFIGURA√á√ÉO ---
        const API_URL = "SUA_URL_DO_GOOGLE_SCRIPT_AQUI"; 

        // --- FUN√á√ïES ---
        function converterFoto() {
            const file = document.getElementById('p-file').files[0];
            const reader = new FileReader();
            reader.onloadend = () => document.getElementById('p-img').value = reader.result;
            if (file) reader.readAsDataURL(file);
        }

        async function handleLogin() {
            const btn = document.querySelector('button'); btn.disabled = true; btn.innerText = "Entrando...";
            const res = await fetch(`${API_URL}?action=login&email=${document.getElementById('email').value}&senha=${document.getElementById('senha').value}`, {redirect: "follow"});
            const user = await res.json();
            
            if(user.auth) {
                localStorage.setItem('vendedor', user.email);
                localStorage.setItem('lojaNome', user.loja || "Minha Loja");
                localStorage.setItem('lojaNicho', user.nicho || "Geral");
                abrirPainel();
            } else { 
                alert("Login incorreto!"); 
                btn.disabled = false; btn.innerText = "Acessar Painel";
            }
        }

        function abrirPainel() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            
            // Atualiza UI com dados locais
            document.getElementById('display-loja').innerText = localStorage.getItem('lojaNome');
            document.getElementById('edit-nome-loja').value = localStorage.getItem('lojaNome');
            document.getElementById('edit-nicho').value = localStorage.getItem('lojaNicho');
            
            // Gera Link da Vitrine (Troca index.html por view.html)
            const linkBase = window.location.href.replace('index.html', 'view.html').split('?')[0]; // Limpa query params antigos
            const linkFinal = linkBase.includes('view.html') ? linkBase : linkBase + 'view.html'; // Garante estrutura
            document.getElementById('share-link').innerText = `${linkFinal}?loja=${localStorage.getItem('vendedor')}`;
            
            carregarMeusProdutos();
        }

        async function carregarMeusProdutos() {
            const container = document.getElementById('meus-produtos');
            container.innerHTML = "<div class='center-align'><progress class='circle'></progress></div>";
            
            const res = await fetch(`${API_URL}?action=getProdutos&dono=${localStorage.getItem('vendedor')}`, {redirect: "follow"});
            const dados = await res.json();
            const lista = dados.produtos || [];

            if(lista.length === 0) { container.innerHTML = "<p class='center-align gray-text'>Nenhum produto cadastrado.</p>"; return; }

            container.innerHTML = lista.map(p => `
                <div class="s12 m6 l4">
                    <div class="card white no-padding shadow margin-bottom" style="position:relative">
                        <span class="badge-estoque">Restam: ${p.estoque}</span>
                        <img src="${p.img}" style="width:100%; height:180px; object-fit:cover; border-radius: 16px 16px 0 0">
                        <div class="padding">
                            <p class="bold" style="margin:0; font-size:1.1rem">${p.nome}</p>
                            <div class="row align-center space-between" style="margin-top:10px">
                                <span class="green-text bold" style="font-size:1.2rem">R$ ${p.preco}</span>
                                <button class="circle transparent red-text" onclick="deletarProduto('${p.nome}')"><i>delete</i></button>
                            </div>
                        </div>
                    </div>
                </div>`).join('');
        }

        async function salvarProduto() {
            const btn = document.getElementById('btn-salvar'); btn.disabled = true; btn.innerText = "Salvando...";
            const dados = {
                action: "cadastrarProduto",
                dono: localStorage.getItem('vendedor'),
                nome: document.getElementById('p-nome').value,
                preco: document.getElementById('p-preco').value,
                estoque: document.getElementById('p-estoque').value,
                img: document.getElementById('p-img').value,
                cat: localStorage.getItem('lojaNicho')
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) });
            alert("Produto Cadastrado!");
            btn.disabled = false; btn.innerText = "Publicar Agora";
            
            // Limpar form
            document.getElementById('p-nome').value = "";
            document.getElementById('p-preco').value = "";
            document.getElementById('p-img').value = "";
            carregarMeusProdutos();
        }

        async function atualizarPerfil() {
            const dados = {
                action: "salvarPerfil",
                email: localStorage.getItem('vendedor'),
                nomeLoja: document.getElementById('edit-nome-loja').value,
                nicho: document.getElementById('edit-nicho').value
            };
            await fetch(API_URL, { method: 'POST', body: JSON.stringify(dados) });
            
            localStorage.setItem('lojaNome', dados.nomeLoja);
            localStorage.setItem('lojaNicho', dados.nicho);
            document.getElementById('display-loja').innerText = dados.nomeLoja;
            alert("Perfil Atualizado!");
        }

        async function deletarProduto(nome) {
            if(!confirm(`Tem certeza que deseja apagar "${nome}"?`)) return;
            const container = document.getElementById('meus-produtos'); container.style.opacity = "0.5";
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({
                action: "deletarProduto", 
                dono: localStorage.getItem('vendedor'), 
                nome: nome
            })});
            container.style.opacity = "1";
            carregarMeusProdutos();
        }

        function logout() { localStorage.clear(); location.reload(); }
        function copiarLink() { navigator.clipboard.writeText(document.getElementById('share-link').innerText); alert("Link Copiado!"); }
        
        window.onload = () => { if(localStorage.getItem('vendedor')) abrirPainel(); };
    </script>
</body>
</html>
